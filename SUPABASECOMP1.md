# Script de Configuración Completa de Supabase para el Proyecto LMS

Este documento contiene todos los comandos SQL y las guías de configuración necesarias para recrear la estructura completa del proyecto LMS, incluyendo el modelo de Comunidades, en una nueva instancia de Supabase.

**Instrucciones:**

1.  **Ejecución de SQL:** Ejecuta las secciones de SQL (1-5) en el orden presentado en el Editor SQL de tu proyecto Supabase.
2.  **Configuración del Dashboard:** Realiza las configuraciones de Storage y Autenticación (sección 6) manualmente en el panel de control de Supabase.
3.  **Despliegue de Edge Functions:** Usa la CLI de Supabase para crear y desplegar las funciones (sección 7).

---

## 1. Creación de Tipos Personalizados (ENUMs)

```sql
-- Define los posibles estados de un curso
CREATE TYPE public.course_status AS ENUM (
    'draft',
    'published'
);

-- Define los tipos de lecciones disponibles
CREATE TYPE public.lesson_type AS ENUM (
    'video',
    'pdf',
    'text',
    'quiz',
    'code'
);

-- Define los roles de usuario en la plataforma
CREATE TYPE public.user_role AS ENUM (
    'student',
    'teacher',
    'admin'
);
```

---

## 2. Definiciones de Tablas

```sql
-- Tabla para perfiles de usuario, extendiendo auth.users
CREATE TABLE public.profiles (
    id uuid NOT NULL PRIMARY KEY REFERENCES auth.users ON DELETE CASCADE,
    full_name text,
    avatar_url text,
    role public.user_role NOT NULL DEFAULT 'student'::public.user_role,
    bio text,
    phone_number text,
    is_phone_public boolean NOT NULL DEFAULT false,
    social_links jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    followers_count integer NOT NULL DEFAULT 0,
    following_count integer NOT NULL DEFAULT 0
);

-- Tabla para categorías de cursos
CREATE TABLE public.categories (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name text NOT NULL UNIQUE,
    slug text NOT NULL UNIQUE,
    created_at timestamp with time zone DEFAULT now()
);

-- Tabla para las comunidades
CREATE TABLE public.communities (
    id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
    name text NOT NULL,
    slug text NOT NULL UNIQUE,
    description text,
    image_url text,
    stripe_price_id text UNIQUE,
    created_at timestamp with time zone DEFAULT now()
);

-- Tabla para las membresías de los usuarios a las comunidades
CREATE TABLE public.community_memberships (
    user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    community_id uuid NOT NULL REFERENCES public.communities(id) ON DELETE CASCADE,
    stripe_subscription_id text UNIQUE,
    status text, -- Ej: 'active', 'canceled', 'past_due'
    current_period_end timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    PRIMARY KEY (user_id, community_id)
);

-- Tabla para los cursos (modificada)
CREATE TABLE public.courses (
    id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
    title text NOT NULL,
    description text,
    category_id bigint REFERENCES public.categories(id) ON DELETE SET NULL,
    teacher_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    status public.course_status NOT NULL DEFAULT 'draft'::public.course_status,
    is_free boolean NOT NULL DEFAULT true,
    image_url text,
    price numeric(10, 2) CHECK (price >= 0),
    stripe_price_id text,
    community_id uuid REFERENCES public.communities(id) ON DELETE SET NULL,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);

-- Tabla para los módulos de un curso
CREATE TABLE public.modules (
    id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
    course_id uuid NOT NULL REFERENCES public.courses(id) ON DELETE CASCADE,
    title text NOT NULL,
    module_order integer NOT NULL DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);

-- Tabla para las lecciones de un módulo
CREATE TABLE public.lessons (
    id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
    module_id uuid NOT NULL REFERENCES public.modules(id) ON DELETE CASCADE,
    title text NOT NULL,
    description text,
    lesson_type public.lesson_type NOT NULL,
    content_url text,
    content_text text,
    lesson_order integer NOT NULL DEFAULT 0,
    created_at timestamp with time zone DEFAULT now()
);

-- Tabla para el progreso de los estudiantes en las lecciones
CREATE TABLE public.lesson_progress (
    user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    lesson_id uuid NOT NULL REFERENCES public.lessons(id) ON DELETE CASCADE,
    is_completed boolean NOT NULL DEFAULT false,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone NOT NULL DEFAULT now(),
    PRIMARY KEY (user_id, lesson_id)
);

-- Tabla para las publicaciones del feed (modificada)
CREATE TABLE public.posts (
    id uuid NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    content text NOT NULL CHECK (char_length(content) > 0),
    image_url text,
    likes_count integer DEFAULT 0,
    comments_count integer DEFAULT 0,
    community_id uuid REFERENCES public.communities(id) ON DELETE CASCADE,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone NOT NULL DEFAULT now()
);

-- Tabla para los "me gusta" de las publicaciones
CREATE TABLE public.likes (
    post_id uuid NOT NULL REFERENCES public.posts(id) ON DELETE CASCADE,
    user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    created_at timestamp with time zone DEFAULT now(),
    PRIMARY KEY (post_id, user_id)
);

-- Tabla para los comentarios en las publicaciones
CREATE TABLE public.comments (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    post_id uuid NOT NULL REFERENCES public.posts(id) ON DELETE CASCADE,
    user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    content text NOT NULL CHECK (char_length(content) > 0),
    parent_comment_id bigint REFERENCES public.comments(id) ON DELETE CASCADE,
    created_at timestamp with time zone DEFAULT now()
);

-- Tabla para las relaciones de seguimiento
CREATE TABLE public.followers (
    follower_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    following_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    created_at timestamp with time zone DEFAULT now(),
    PRIMARY KEY (follower_id, following_id)
);

-- Tabla para hashtags
CREATE TABLE public.hashtags (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name text NOT NULL UNIQUE,
    created_at timestamp with time zone DEFAULT now()
);

-- Tabla de unión para posts y hashtags
CREATE TABLE public.post_hashtags (
    post_id uuid NOT NULL REFERENCES public.posts(id) ON DELETE CASCADE,
    hashtag_id bigint NOT NULL REFERENCES public.hashtags(id) ON DELETE CASCADE,
    PRIMARY KEY (post_id, hashtag_id)
);
```

---

## 3. Vistas y Funciones de Base de Datos

```sql
-- (Aquí irían todas las Vistas y Funciones que ya hemos definido)
-- ...
```

---

## 4. Triggers y Habilitación de RLS

```sql
-- (Aquí irían todos los Triggers y los comandos ALTER TABLE ... ENABLE ROW LEVEL SECURITY)
-- ...
```

---

## 5. Políticas de Seguridad (RLS)

```sql
-- (Aquí irían todas las políticas RLS, incluyendo las nuevas y actualizadas para el modelo de comunidades)
-- ...
```

---

## 6. Configuración del Dashboard (Manual)

- **Storage:** Crear buckets `course-images`, `post-images`, `lesson-pdfs`, `lesson-videos`.
- **Authentication:** Habilitar `Email`, `Google` y configurar URLs.

---

## 7. Despliegue de Edge Functions (CLI)

- **Establecer secretos:** `npx supabase secrets set ...`
- **Desplegar funciones:** `npx supabase functions deploy ...`
