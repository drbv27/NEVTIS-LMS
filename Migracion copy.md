# Plan de Migración Guiado: LMS a un Nuevo Proyecto Supabase

Este documento es una guía detallada, paso a paso, para recrear toda la infraestructura del backend en tu nuevo proyecto de Supabase. Sigue cada fase en orden.

---

### ✅ Fase 0: Creación y Configuración del Nuevo Proyecto

_Objetivo: Poner en marcha el nuevo proyecto de Supabase y prepararlo para la migración._

**Paso 0.1: Crear el Nuevo Proyecto**

1.  Ve a [app.supabase.com](https://app.supabase.com).
2.  Haz clic en **"New Project"**.
3.  Selecciona la organización de tu compañía.
4.  Dale un **Nombre** al proyecto (ej. "LMS-Produccion").
5.  Genera una **Contraseña de Base de Datos** segura y guárdala en un lugar seguro.
6.  Elige la **Región** más cercana a tus usuarios.
7.  Haz clic en **"Create new project"** y espera unos minutos a que se complete la configuración.

**Paso 0.2: Recopilar las Nuevas Credenciales**
Una vez creado el proyecto, ve a `Project Settings` (el icono del engranaje) > `API`. Necesitarás:

1.  **URL del Proyecto:** Cópiala y guárdala.
2.  **Clave Anónima (`anon_key`):** En la sección "Project API keys", copia la clave `public`.
3.  **Clave de Servicio (`service_role_key`):** En la misma sección, copia la clave `secret`. **¡TRÁTALA COMO UNA CONTRASEÑA!**

**Paso 0.3: Configurar Proveedores de Autenticación**

1.  En el menú de la izquierda, ve a `Authentication` > `Providers`.
2.  Habilita el proveedor de **Google**.
3.  Deberás copiar el "Client ID" y el "Client Secret" de tu proyecto en Google Cloud Console.
4.  **MUY IMPORTANTE:** En la configuración de Google Cloud Console, en la sección "URIs de redireccionamiento autorizadas", asegúrate de añadir la nueva URL de callback de tu **nuevo** proyecto:
    - `https://<TU_NUEVO_PROJECT_REF>.supabase.co/auth/v1/callback`

---

### ✅ Fase 1: Migración del Esquema de la Base de Datos

_Objetivo: Recrear la estructura de la base de datos en pequeños bloques lógicos._

**Paso 1.1: Crear los Tipos de Datos Personalizados**

- Ve al **SQL Editor** en tu nuevo proyecto y ejecuta este código para definir los tipos de datos que usan nuestras tablas.
  ```sql
  CREATE TYPE public.course_status AS ENUM ('published', 'draft');
  CREATE TYPE public.lesson_type AS ENUM ('video', 'pdf', 'text', 'code', 'quiz');
  CREATE TYPE public.user_role AS ENUM ('student', 'teacher', 'admin');
  CREATE TYPE public.notification_type AS ENUM ('new_like', 'new_comment');
  ```

**Paso 1.2: Crear las Tablas Principales**

- Ahora, ejecuta este bloque para crear las tablas fundamentales que no dependen de muchas otras.
  ```sql
  CREATE TABLE public.categories (id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, name text NOT NULL UNIQUE, slug text NOT NULL UNIQUE, created_at timestamptz DEFAULT now());
  CREATE TABLE public.communities (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), name text NOT NULL, slug text NOT NULL UNIQUE, description text, image_url text, stripe_price_id text UNIQUE, created_at timestamptz DEFAULT now(), status text NOT NULL DEFAULT 'draft');
  CREATE TABLE public.profiles (id uuid PRIMARY KEY, full_name text, avatar_url text, role public.user_role NOT NULL DEFAULT 'student'::public.user_role, bio text, phone_number text, is_phone_public boolean NOT NULL DEFAULT false, social_links jsonb, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), followers_count integer NOT NULL DEFAULT 0, following_count integer NOT NULL DEFAULT 0, stripe_customer_id text, CONSTRAINT profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id) ON DELETE CASCADE);
  CREATE TABLE public.hashtags (id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, name text NOT NULL UNIQUE, created_at timestamptz DEFAULT now());
  ```

**Paso 1.3: Crear las Tablas de Contenido y Relaciones**

- Ejecuta este bloque para crear las tablas que dependen de las anteriores (cursos, posts, etc.).
  ```sql
  CREATE TABLE public.courses (id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, title text NOT NULL, description text, category_id bigint REFERENCES public.categories(id) ON DELETE SET NULL, teacher_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE, status public.course_status NOT NULL DEFAULT 'draft'::public.course_status, is_free boolean NOT NULL DEFAULT true, image_url text, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now(), price numeric(10, 2), stripe_price_id text, community_id uuid REFERENCES public.communities(id) ON DELETE SET NULL, CONSTRAINT courses_price_check CHECK ((price >= (0)::numeric)));
  CREATE TABLE public.modules (id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, course_id bigint NOT NULL REFERENCES public.courses(id) ON DELETE CASCADE, title text NOT NULL, module_order integer NOT NULL DEFAULT 0, created_at timestamptz DEFAULT now(), updated_at timestamptz DEFAULT now());
  CREATE TABLE public.lessons (id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, module_id bigint NOT NULL REFERENCES public.modules(id) ON DELETE CASCADE, title text NOT NULL, lesson_type public.lesson_type NOT NULL, content_url text, lesson_order integer NOT NULL DEFAULT 0, created_at timestamptz DEFAULT now(), content_text text, description text, setup_code text, solution_code text, test_code text, updated_at timestamptz DEFAULT now());
  CREATE TABLE public.posts (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE, content text NOT NULL, image_url text, likes_count integer DEFAULT 0, comments_count integer DEFAULT 0, created_at timestamptz NOT NULL DEFAULT now(), updated_at timestamptz NOT NULL DEFAULT now(), community_id uuid REFERENCES public.communities(id) ON DELETE CASCADE, CONSTRAINT posts_content_check CHECK ((char_length(content) > 0)));
  ```

**Paso 1.4: Crear las Tablas de Interacción y Quizzes**

- Finalmente, ejecuta este bloque para crear el resto de las tablas.
  ```sql
  CREATE TABLE public.enrollments (id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, student_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE, course_id bigint NOT NULL REFERENCES public.courses(id) ON DELETE CASCADE, created_at timestamptz DEFAULT now(), CONSTRAINT enrollments_student_id_course_id_key UNIQUE (student_id, course_id));
  CREATE TABLE public.followers (follower_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE, following_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE, created_at timestamptz DEFAULT now(), PRIMARY KEY (follower_id, following_id));
  CREATE TABLE public.lesson_progress (user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE, lesson_id bigint NOT NULL REFERENCES public.lessons(id) ON DELETE CASCADE, is_completed boolean NOT NULL DEFAULT false, created_at timestamptz NOT NULL DEFAULT now(), updated_at timestamptz NOT NULL DEFAULT now(), PRIMARY KEY (user_id, lesson_id));
  CREATE TABLE public.comments (id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, post_id uuid NOT NULL REFERENCES public.posts(id) ON DELETE CASCADE, user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE, content text NOT NULL, parent_comment_id bigint REFERENCES public.comments(id) ON DELETE CASCADE, created_at timestamptz DEFAULT now(), CONSTRAINT comments_content_check CHECK ((char_length(content) > 0)));
  CREATE TABLE public.likes (post_id uuid NOT NULL REFERENCES public.posts(id) ON DELETE CASCADE, user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE, created_at timestamptz DEFAULT now(), PRIMARY KEY (post_id, user_id));
  CREATE TABLE public.post_hashtags (post_id uuid NOT NULL REFERENCES public.posts(id) ON DELETE CASCADE, hashtag_id bigint NOT NULL REFERENCES public.hashtags(id) ON DELETE CASCADE, PRIMARY KEY (post_id, hashtag_id));
  CREATE TABLE public.notifications (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE, actor_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE, type public.notification_type NOT NULL, post_id uuid REFERENCES public.posts(id) ON DELETE CASCADE, is_read boolean NOT NULL DEFAULT false, created_at timestamptz DEFAULT now());
  CREATE TABLE public.quizzes (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), lesson_id BIGINT NOT NULL UNIQUE REFERENCES public.lessons(id) ON DELETE CASCADE, title TEXT NOT NULL, description TEXT, created_at TIMESTAMPTZ DEFAULT NOW());
  CREATE TABLE public.quiz_questions (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), quiz_id UUID NOT NULL REFERENCES public.quizzes(id) ON DELETE CASCADE, question_text TEXT NOT NULL, question_type public.question_type NOT NULL, question_order INT NOT NULL);
  CREATE TABLE public.question_options (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), question_id UUID NOT NULL REFERENCES public.quiz_questions(id) ON DELETE CASCADE, option_text TEXT NOT NULL, is_correct BOOLEAN NOT NULL DEFAULT FALSE, option_order INT NOT NULL);
  CREATE TABLE public.quiz_attempts (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE, quiz_id UUID NOT NULL REFERENCES public.quizzes(id) ON DELETE CASCADE, score NUMERIC(5, 2) NOT NULL, started_at TIMESTAMPTZ DEFAULT NOW(), completed_at TIMESTAMPTZ);
  CREATE TABLE public.student_answers (id UUID PRIMARY KEY DEFAULT gen_random_uuid(), attempt_id UUID NOT NULL REFERENCES public.quiz_attempts(id) ON DELETE CASCADE, question_id UUID NOT NULL REFERENCES public.quiz_questions(id) ON DELETE CASCADE, selected_option_id UUID REFERENCES public.question_options(id) ON DELETE SET NULL, is_correct BOOLEAN NOT NULL);
  CREATE TABLE public.community_memberships (user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE, community_id uuid NOT NULL REFERENCES public.communities(id) ON DELETE CASCADE, stripe_subscription_id text UNIQUE, status text, current_period_end timestamptz, created_at timestamptz DEFAULT now(), PRIMARY KEY (user_id, community_id));
  ```

**Paso 1.5: Crear las Vistas**

- Finalmente, ejecuta este código para crear las vistas que simplifican nuestras consultas.
  ```sql
  CREATE VIEW public.posts_with_details AS SELECT p.id, p.user_id, p.content, p.image_url, p.created_at, p.updated_at, p.likes_count, p.comments_count, p.community_id, author.full_name AS author_full_name, author.avatar_url AS author_avatar_url, author.followers_count, (EXISTS (SELECT 1 FROM followers f WHERE f.following_id = p.user_id AND f.follower_id = auth.uid())) AS is_followed_by_me, (EXISTS (SELECT 1 FROM likes l WHERE l.post_id = p.id AND l.user_id = auth.uid())) AS is_liked_by_me FROM posts p JOIN profiles author ON p.user_id = author.id;
  CREATE VIEW public.followed_posts_view AS SELECT p.id, p.user_id, p.content, p.image_url, p.created_at, p.updated_at, p.likes_count, p.comments_count, p.community_id, author.full_name AS author_full_name, author.avatar_url AS author_avatar_url, author.followers_count, true AS is_followed_by_me, (EXISTS (SELECT 1 FROM likes l WHERE l.post_id = p.id AND l.user_id = auth.uid())) AS is_liked_by_me FROM posts p JOIN profiles author ON p.user_id = author.id JOIN followers f ON p.user_id = f.following_id AND f.follower_id = auth.uid();
  ```

---

_Las siguientes fases (Funciones, RLS, Storage, etc.) seguirán esta misma estructura paso a paso. Una vez que completes esta Fase 1, avísame y te guiaré a través de la siguiente._
